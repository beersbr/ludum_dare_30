<!doctype html>
<html>
<head>
	<title>Editor</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="./css/editor.css">
</head>
<body>

	<div class="content" >
		<ul id="states">
			<dl><dt><label><input type="radio" name="state" id="tile-state" value="passable"> passable</label></dt></dl>
			<dl><dt><label><input type="radio" name="state" id="tile-state" value="liquid"> liquid</label></dt></dl>
			<dl><dt><label><input type="radio" name="state" id="tile-state" value="slick"> slick</label></dt></dl>
			<dl><dt><label><input type="radio" name="state" id="tile-state" value="solid"> solid</label></dt></dl>	
			<dl><dt><label>door: <input type="checkbox" name="door" id="tile-door" value="true"></label></dt></dl>
			<dl><dt><label>damage: <input type="input" name="damage" id="tile-damage" value="0"></label></dt></dl>			
		</ul>
		<ul id="tiles">
		</ul>
	</div>

	<div class="content">
		<table id="editor-table">
<?php 
$rows = 14;
$cols = 20;

$map = array();

for($r = 1; $r <= $rows; $r++) {
	$map["row-".$r] = array();
	echo "<tr class='row' id='row-".$r."'>\n";
	for($c = 1; $c <= $cols; $c++) {
		$map["row-".$r]["col-".$c] = array("image" => "", "state" => "", "damage" => 0, "door" => 0);
		
		echo "<td class='col-".$c."' data-col='col-".$c."' data-row='row-".$r."'></td>\n";
	}
}
?>
		</table>
	</div>
	<div class="file">
		<textarea id="output"></textarea>
		<button id="save">Generate</button>
		<button id="load">Load</button>
	</div>

</body>
<script type="text/javascript">

var map = <?php echo(json_encode($map)); ?>;

function desc(name, image){
	var t = "<dl class='item' id='"+name+"'><dt>"+name+"</dt><dd>"+image[0].outerHTML+"</dd></dl>";

	return t;
}

function setup(){
	var selected_key = Object.keys(images)[0];

	$("dl").on("click", function(){
		selected_key = $(this).find("dt").html();
	})

	$("td").on("click", function(){
		$(this).html(images[selected_key].outerHTML);
		map[$(this).data("row")][$(this).data("col")] = {
			"image": selected_key,
			"state": $("#tile-state:checked").val(),
			"damage": $("#tile-damage").val(),
			"door": $("#tile-door").is(':checked')
		};
		console.log(map[$(this).data("row")][$(this).data("col")]);
	});

	$("#save").on("click", function(){		
		$("#output").val(JSON.stringify(map));
	});

	$("#load").on("click", function(){	
		map = JSON.parse($("#output").val());
		
		for(var r in map) {
			for(var c in map[r]) {
				$("#"+r+" ."+c).html("<img src='"+tiles[map[r][c]['image']]+"' />");
			}
		}
	});
}

$(document).ready(function(){

	images = {};
	tiles = {};
	$.ajax({url: "json/tiles.json"}).success(function(e){
		console.log(e);
		tiles = e;

		var len = Object.keys(e).length;
		var loaded = 0;

		for(var k in e){
			images[k] = new Image;
			images[k].src = e[k];
			images[k].onload = (function(evt){
				$(images[this]).attr("data-name", this);
				$("#tiles").append($(desc(this, $(images[this]) ) ));
				loaded += 1;
				if(loaded == len)
					setup();
			}).bind(k)
		}
	});



});

</script>
</html>